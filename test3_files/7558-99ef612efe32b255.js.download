try{let e="undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof globalThis?globalThis:"undefined"!=typeof self?self:{},t=(new e.Error).stack;t&&(e._sentryDebugIds=e._sentryDebugIds||{},e._sentryDebugIds[t]="7a967a94-6609-421f-92ba-b923049cb5a4",e._sentryDebugIdIdentifier="sentry-dbid-7a967a94-6609-421f-92ba-b923049cb5a4")}catch(e){}"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[7558],{16304:(e,t,a)=>{a.d(t,{V:()=>l});var n=a(7620),s=a(88769),i=a(24423);function l(e,t,a){let l=(0,i.Gu)(),{clearAllFeatures:r}=(0,s.Bk)();(0,n.useLayoutEffect)(()=>(!a&&t.length>0&&l(e,t),()=>{r()}),[e,t,a,l,r])}},71302:(e,t,a)=>{a.r(t),a.d(t,{PaymentVerificationModal:()=>p});var n=a(54568),s=a(74813),i=a(64328),l=a(45054),r=a(77223),o=a(26819),u=a(3075),d=a(4869),c=a(7620),m=a(59666),f=a(48579),v=a(89060);function p(){let[e,t]=(0,c.useState)(!1),a=(0,s.st)(),{activeOrganization:p}=(0,i.YL)(),{addError:_,addSuccess:g}=(0,l.Y)(),y=(0,r.ib)(),h=(0,d.useQueryClient)(),{shouldShowModal:x,dismissReminder:b}=(0,v.F)(),j=(0,f.Si)({onSuccess:async e=>{try{var s,i;let t=await y;if(!t)throw Error("Stripe failed to initialize");let l=await t.retrieveSetupIntent(e.clientSecret);if(l.error)throw Error(l.error.message);if((null==(s=l.setupIntent)?void 0:s.status)==="requires_action"){let a=await t.handleNextAction({clientSecret:e.clientSecret});if(a.error)throw Error(a.error.message)}else(null==(i=l.setupIntent)?void 0:i.status)==="succeeded"&&a.track({event_key:"payment_modal_open",organization_id:null==p?void 0:p.uuid,action:"verify_3ds_success_frictionless"});await h.invalidateQueries({queryKey:["check-3ds-required",null==p?void 0:p.uuid]}),a.track({event_key:"payment_modal_open",organization_id:null==p?void 0:p.uuid,action:"verify_3ds_success"}),g((0,n.jsx)(m.A,{defaultMessage:"Payment method verified successfully",id:"vRXoCh/o7W"})),a.track({event_key:"payment_modal_open",organization_id:null==p?void 0:p.uuid,action:"verify_3ds_success"})}catch(e){_(e instanceof Error&&"PAYMENT_VERIFICATION_FAILED"===e.message?(0,n.jsx)(m.A,{defaultMessage:"Payment verification failed",id:"9RpX03Q2ky"}):e instanceof Error?e.message:(0,n.jsx)(m.A,{defaultMessage:"Payment verification failed. Please try again.",id:"0kXa3Rf5bZ"}),{error:e}),a.track({event_key:"payment_modal_open",organization_id:null==p?void 0:p.uuid,action:"verify_3ds_error",error_message:e instanceof Error?e.message:"Unknown error"})}finally{t(!1)}},onError:e=>{t(!1),_((0,n.jsx)(m.A,{defaultMessage:"Failed to start verification process. Please try again.",id:"3dT/r8rV5S"}),{error:e}),a.track({event_key:"payment_modal_open",organization_id:null==p?void 0:p.uuid,action:"verify_3ds_api_error",error_message:e.message})}}),w=()=>{b()};return x?(0,n.jsx)(u.aF,{isOpen:x,onClose:w,modalSize:"md",hasCloseButton:!0,title:(0,n.jsx)("div",{className:"flex items-center gap-2",children:(0,n.jsx)(o.E,{color:"secondary",size:"lg",children:(0,n.jsx)(m.A,{defaultMessage:"Action Required",id:"jWgFDt2Ifa"})})}),children:(0,n.jsxs)("div",{className:"mt-4",children:[(0,n.jsx)("h2",{className:"text-3xl font-medium text-text-100 mb-3",children:(0,n.jsx)(m.A,{defaultMessage:"Verify your payment method",id:"epYApo9bIj"})}),(0,n.jsx)("p",{className:"text-text-200 mb-6",children:(0,n.jsx)(m.A,{defaultMessage:"To comply with European security regulations, we need to verify your payment method using a quick one-time security process. This ensures your subscription remains active and secure.",id:"K0hDpiUx0B"})}),(0,n.jsxs)("div",{className:"flex flex-col gap-2 mt-6",children:[(0,n.jsx)(u.yl,{onClick:()=>{t(!0),a.track({event_key:"payment_modal_open",organization_id:null==p?void 0:p.uuid,action:"verify_3ds_start"});let e=window.location.href;j.mutate({return_url:e})},loading:e,className:"w-full",children:(0,n.jsx)(m.A,{defaultMessage:"Verify now",id:"t28SE7zKVA"})}),(0,n.jsx)(u.yl,{variant:"secondary",onClick:w,className:"w-full",children:(0,n.jsx)(m.A,{defaultMessage:"Remind me later",id:"c4hRLOnYpQ"})})]})]})}):null}},89060:(e,t,a)=>{a.d(t,{F:()=>u});var n=a(74813),s=a(64328),i=a(68067),l=a(7620),r=a(48579);let o="payment-verification-reminder-dismissed";function u(){let{activeOrganization:e}=(0,s.YL)(),t=(0,n.st)(),[a,u]=(0,l.useState)(!1),{value:d}=(0,i.fS)("show_3ds_modal"),{data:c}=(0,r.PI)(d);return(0,l.useEffect)(()=>{var a;let n=localStorage.getItem(o);if(n){let e=new Date(n).getTime();if(new Date().getTime()-e<864e5)return void u(!1)}let s=d&&null!=(a=null==c?void 0:c.requires_3ds_verification)&&a;u(s),s&&t.track({event_key:"payment_modal_open",organization_id:null==e?void 0:e.uuid,modal_type:"3ds_verification_required"})},[d,c,t,e]),{shouldShowModal:a,dismissReminder:(0,l.useCallback)(()=>{let a=new Date().toISOString();localStorage.setItem(o,a),u(!1),t.track({event_key:"payment_modal_open",organization_id:null==e?void 0:e.uuid,action:"3ds_verification_dismissed",dismissed_at:a})},[t,e])}}},97558:(e,t,a)=>{a.d(t,{ChatClientPage:()=>K});var n=a(54568),s=a(19736),i=a(47592),l=a(18849),r=a(58841),o=a(64328),u=a(41473),d=a(7620),c=a(96614),m=a(68704),f=a(74813),v=a(98944),p=a(27541),_=a(55188),g=a(59294),y=a(24423),h=a(98324),x=a(69351),b=a(44007),j=a(96547),w=a(50571),k=a(35580),S=a(73648),C=a(23812),A=a(3075),E=a(73996),M=a(59666),I=a(45271),N=a(99411),T=a(4899),z=a(72253);function O(e){let{isModalOpen:t,currentTool:a,currentToolInput:s,currentServer:i,handleDeny:l,handleAllow:r,handleAlwaysAllow:o}=e,{isExpanded:u,setIsExpanded:d,snappyTransition:c}=(0,z.a)(!1);if(a)return(0,n.jsxs)(A.aF,{isOpen:t,onClose:()=>l(),autoCloseOnFocusOut:!1,closeOnEscapeKeydown:!1,modalSize:"lg",title:(0,n.jsx)(M.A,{defaultMessage:"Claude would like to use this tool",id:"PwE/s/W1AC"}),children:[(0,n.jsx)("div",{className:"mt-4"}),(0,n.jsx)(N.sH,{isStreaming:!1,isExpanded:u,setIsExpanded:d,isFirstBlockOfMessage:!0,isLastBlockOfMessage:!0,text:(0,n.jsx)(E.fI,{className:"!py-0",children:(0,n.jsxs)("div",{className:"flex gap-4 items-center",children:[(0,n.jsx)(I.z,{size:42,imageSize:24,type:(null==i?void 0:i.iconType)||"favicon",src:null==i?void 0:i.iconSrc,name:(null==i?void 0:i.name)||a.name}),(0,n.jsxs)("div",{className:"flex flex-col py-1",children:[(0,n.jsx)("div",{className:"text-sm text-text-400 font-mono",children:a.name}),(null==i?void 0:i.name)&&(0,n.jsx)("span",{className:"font-medium text-[0.9rem] pt-1",children:i.name})]})]})}),className:"!h-auto",children:(0,n.jsx)(N.NG,{isExpanded:u,snappyTransition:c,isScrollable:!0,children:(0,n.jsx)(T.L,{input:s?JSON.parse(s):""})})}),(0,n.jsxs)("div",{className:"flex flex-col p-4 gap-4 bg-bg-300 my-4 rounded-lg border-0.5 border-border-300",children:[(0,n.jsx)("p",{className:"font-medium",children:(0,n.jsx)(M.A,{defaultMessage:"Review each action carefully before approving",id:"IaQzFuy2mt"})}),(0,n.jsx)("p",{children:(0,n.jsx)(M.A,{defaultMessage:"Claude cannot guarantee the security or privacy practices of third-party integrations.",id:"3gyayAmXQv"})})]}),(0,n.jsx)(A.vW,{className:"flex justify-between",children:(0,n.jsxs)(n.Fragment,{children:[(0,n.jsxs)("div",{className:"flex gap-2",children:[o&&(0,n.jsx)(C.$,{onClick:o,children:(0,n.jsx)(M.A,{defaultMessage:"Allow always",id:"F8zkKBCp6U"})}),(0,n.jsx)(C.$,{onClick:r,autoFocus:!0,children:(0,n.jsx)(M.A,{defaultMessage:"Allow once",id:"O2tb5KUxpc"})})]}),(0,n.jsx)(C.$,{onClick:l,variant:"outline",children:(0,n.jsx)(M.A,{defaultMessage:"Decline",id:"pvtgR26QWY"})})]})})]})}var R=a(1613),D=a(45054),F=a(16178),P=a(80688),L=a(8019),U=a(4869);function q(e){var t,a,i,l;let{conversation:r,conversationUuid:C,chatInputDefaultMessage:A}=e,E=(0,p.useRouter)(),{incognitoModeEnabled:M}=(0,_.S)(),{track:I}=(0,f.st)(),{data:N,isLoading:T,isRefetching:z,isPlaceholderData:q}=(0,s.Bq)(C,{suppressError:!0}),Q=(0,d.useMemo)(()=>{if((null==N?void 0:N.danglingHumanMessages)&&N.danglingHumanMessages.length>0)return N.danglingHumanMessages[N.danglingHumanMessages.length-1]},[N]),B=null==N?void 0:N.project_uuid,K=(0,y.gq)(),Y=(0,y.xw)(C),{changeDisplayedConversationPath:V}=(0,m.G)(),{onInvokeTool:G,isModalOpen:H,currentTool:W,currentToolInput:X,currentServer:Z,handleAllow:$,handleDeny:J,handleAlwaysAllow:ee}=function(e){let{conversationUuid:t}=e,a=(0,x.M)(),{track:n}=(0,f.st)(),[s,i]=(0,d.useState)(!1),[l,r]=(0,d.useState)(null),[o,u]=(0,d.useState)(null),[c,m]=(0,d.useState)(void 0),[v,p]=(0,d.useState)(null),[_,g]=(0,d.useState)(null),[y,h]=(0,d.useState)(void 0),[C,A]=(0,d.useState)(!1),E=(0,b.p9)(),M=(0,w.HJ)(),{toggleMcpToolAlwaysApproved:I}=(0,w.es)(),{getApprovalSetting:N}=(0,w.BN)(),{mutate:T}=(0,j.p4)(t),z=(0,d.useCallback)(async(e,t,n,s,l,o,d)=>{if(M)return;let c=(0,k.pK)(t),f=null==c?void 0:c.tool,v=null==c?void 0:c.server;if(!f)return a(e,t,n,s,l);if(E&&(null==v?void 0:v.type)==="remote")return o?new Promise(e=>{r(t),m(v),u(f),p(n),g(s),A(o.includes("always")),h(d),i(!0),e()}):void 0;let _=N(null==v?void 0:v.name,f);return"never"===_?a(e,t,n,s,l):new Promise(e=>{r(t),A("ask"===_),m(v),u(f),p(n),g(s),i(!0),e()})},[a,N,E,M]),O=(0,d.useCallback)(()=>{i(!1),l&&null!==v&&null!==_&&(y?T({tool_use_id:v,is_approved:!0}):a(t,l,v,_))},[t,l,v,_,a,y,T]),R=(0,d.useCallback)(()=>{if(i(!1),l&&null!==v&&null!==_)if(y)T({tool_use_id:v,is_approved:!1});else{var e;a(t,l,v,_,{overriddenResult:{content:[{type:"text",text:"The user has chosen to disallow the tool call."}],is_error:!0}}),n({event_key:"mcp.tools.called",result:"disallowed",argument_count:Object.keys(null!=(e=(0,S.p)(_))?e:{}).length})}},[t,l,v,_,a,n,y,T]),D=(0,d.useCallback)(()=>{C&&(o&&!y&&I(o.alwaysApprovedKey,!0),i(!1),l&&null!==v&&null!==_&&(y&&T({tool_use_id:v,is_approved:!0,approval_key:y,approval_option:"always"}),a(t,l,v,_)))},[t,l,o,v,_,a,I,C,y,T]);return{onInvokeTool:z,isModalOpen:s,currentTool:o,currentServer:c,currentToolInput:_,handleAllow:O,handleDeny:R,handleAlwaysAllow:C?D:void 0}}({conversationUuid:C}),et=(0,c.Z3)(C),ea=(0,x.n)(null==N||null==(t=N.settings)?void 0:t.enabled_mcp_tools,null==r?void 0:r.project_uuid),{markFirstTokenReceived:en}=(0,g.B)(),es=(0,d.useCallback)(()=>{en({model:et,integrations:function(e){if(!e)return"";let t=[];return Object.entries(e).forEach(e=>{var a,n;let[s,i]=e,l="enabled_mcp_tools"===s&&!("object"!=typeof i||null===i||Array.isArray(i))&&Object.values(i).every(e=>"boolean"==typeof e),r="paprika_mode"===s&&"string"==typeof(a=i)&&"extended"===a,o="compass_mode"===s&&"string"==typeof(n=i)&&"advanced"===n;l?Object.entries(i).forEach(e=>{let[a,n]=e;n&&t.push(a)}):r?t.push("enabled_paprika"):o?t.push("enabled_compass"):"boolean"==typeof i&&i&&t.push(s)}),t.join(",")}(null==N?void 0:N.settings)})},[en,et,null==N?void 0:N.settings]);(0,d.useEffect)(()=>{if(!M||!(null==N?void 0:N.updated_at))return;let e=()=>{let e=new Date(N.updated_at).getTime();(Date.now()-e)/36e5>=47&&E.push("/new")};return window.addEventListener("focus",e),()=>{window.removeEventListener("focus",e)}},[M,null==N?void 0:N.updated_at,E]);let[ei,el]=(0,d.useState)(),er=(0,d.useCallback)(e=>{el(e)},[el]),[eo,eu]=(0,d.useState)(0),ed=(0,d.useCallback)(e=>{eu(e)},[]),ec=(0,c.Gw)(C,B,G,ea,es,K,ed),em=(0,c.SL)(C,B,G,ea,ei,es,K,ed),{mutate:ef}=(0,s.lj)(C),ev=ec.isStreaming||em.isStreaming,ep=(0,d.useCallback)(async e=>(eu(0),ec.runStream(e)),[ec]),e_=(0,d.useCallback)(async(e,t,a,n)=>(eu(0),em.runStream(e,t,a,n)),[em]);!function(e){var t;let[a,n]=(0,d.useState)(!1),{activeOrganization:i}=(0,o.YL)(),l=null==e?void 0:e.name,r=(null==e||null==(t=e.chat_messages)?void 0:t.length)||0,c=(0,d.useMemo)(()=>{var t;return(null==e||null==(t=e.chat_messages)?void 0:t[0])?(0,u.C)(e.chat_messages[0]):""},[e]),m=(null==e?void 0:e.uuid)||"",{mutate:f}=(0,s.HI)(m),{mutate:v,error:p}=(0,s.OZ)(m),_=(0,d.useRef)(!1);(0,d.useEffect)(()=>{if(p&&!l&&c){if(_.current)return;let e=c.slice(0,30),t=c.length>30?"...":"";_.current=!0,f({name:"".concat(e).concat(t)})}},[p,l,c,f]),(0,d.useEffect)(()=>{i&&!a&&!l&&0!==r&&c&&(n(!0),v({message_content:c,recent_titles:[]}))},[i,l,v,a,r,c])}(N);let eg=null==(a=(0,y.Q3)(C))?void 0:a.uuid,ey=(0,d.useCallback)(async(e,t)=>{var a,n;I({event_key:"claudeai.message.edited",is_last_human_message:e.uuid===eg}),await ep({prompt:t,attachments:e.attachments,files:null!=(n=e.files_v2)?n:e.files,syncSources:e.sync_sources,parent_message_uuid:e.parent_message_uuid,personalized_style:ei,compass_mode:null==(a=e.metadata)?void 0:a.compass_mode})},[ep,ei,I,eg]),eh=(0,d.useCallback)((e,t)=>{I({event_key:"claudeai.conversation_tree.navigated",direction:1===t?"next":"previous",is_last_human_message:e.uuid===eg}),V(C,e,t,e=>ef({current_leaf_message_uuid:e}))},[V,C,ef,I,eg]),{hasPendingUserMessage:ex,isCompletionStatusLoading:eb,stopPendingRecovery:ej}=function(e){let{conversationUuid:t,pendingUserMessage:a,chatConversationTree:n,isLoading:s}=e,i=(0,d.useRef)(!1),l=(0,d.useRef)(null),r=(0,d.useRef)(null),u=(0,d.useRef)(null),m=(0,y.uQ)(),f=(0,y.Gu)(),v=(0,y.RR)(),{activeOrganization:p}=(0,o.YL)(),{addError:_}=(0,D.Y)(),{setFailedStreamRetryData:g}=(0,c.x)(),h=(0,U.useQueryClient)(),[x,b]=(0,d.useState)(!1),[j,w]=(0,d.useState)(!1),{data:k,isLoading:S}=(0,R.Sk)((null==p?void 0:p.uuid)&&t&&a?"/api/organizations/".concat(p.uuid,"/chat_conversations/").concat(t,"/completion_status?poll=false"):"",{enabled:!!(null==p?void 0:p.uuid)&&!!t&&!s&&!!a&&!i.current,staleTime:0,refetchOnWindowFocus:!1}),C=(0,d.useCallback)(()=>{var e;a&&g({prompt:(null!=(e=a.content)?e:[]).filter(e=>"text"===e.type).map(e=>e.text).join(""),attachments:a.attachments||[],files:a.files_v2||[]})},[a,g]),A=(0,d.useCallback)(()=>{r.current&&(r.current.abort(),r.current=null),u.current&&(clearTimeout(u.current),u.current=null)},[]),E=(0,d.useCallback)(()=>{let e=v(t),n=e.filter(e=>e.uuid!==(null==a?void 0:a.uuid)&&e.uuid!==l.current);n.length!==e.length&&f(t,n)},[t,v,null==a?void 0:a.uuid,f]),M=(0,d.useCallback)((e,t)=>{E(),C();let a=e||"Message failed. Please try again.";_(a,{error:new F.LG(a,t||"completion_error",500,{})})},[E,C,_]),I=(0,d.useCallback)(()=>{if(!(null==p?void 0:p.uuid)||!t||!a)return;w(!0),r.current=new AbortController;let e=0,n=async()=>{var a,s,i;if(e>=10||(null==(a=r.current)?void 0:a.signal.aborted))return void w(!1);e++;try{let e=await fetch("/api/organizations/".concat(p.uuid,"/chat_conversations/").concat(t,"/completion_status?poll=true"),{method:"GET",credentials:"include",signal:null==(s=r.current)?void 0:s.signal});if(!e.ok)return void w(!1);let a=await e.json();a.is_pending?(null==(i=r.current)?void 0:i.signal.aborted)||(u.current=setTimeout(()=>void n(),2e3)):(b(!1),w(!1),E(),a.is_error&&M(a.error_detail,a.error_code),await h.invalidateQueries({queryKey:[P.fC,{orgUuid:p.uuid},{uuid:t}]}))}catch(e){w(!1)}};n()},[null==p?void 0:p.uuid,t,a,h,M,E]);return(0,d.useEffect)(()=>{if(!s&&!i.current&&a&&n&&void 0!==k){if(i.current=!0,k.is_error)M(k.error_detail,k.error_code);else if(k.is_pending){b(!0);let e=(0,L.b)();l.current=e;let n={uuid:e,sender:"assistant",content:[{type:"text",text:""}],created_at:new Date().toISOString(),updated_at:new Date().toISOString(),parent_message_uuid:a.uuid,attachments:[],files:[],files_v2:[],sync_sources:[],index:1,metadata:{is_resume_completion_placeholder_message:!0}};m(t,[a,n]),I()}}},[s,a,n,k,M,m,t,I]),(0,d.useEffect)(()=>()=>{A()},[A]),{hasPendingUserMessage:x,isCompletionStatusLoading:!!a&&S&&!j,stopPendingRecovery:()=>w(!1)}}({conversationUuid:C,chatConversationTree:N,pendingUserMessage:Q,isLoading:T});N||T||q||(0,p.notFound)();let ew=(0,d.useMemo)(()=>(null==N?void 0:N.settings)||{},[null==N?void 0:N.settings]);return(0,n.jsxs)(v.N,{settings:ew,children:[(0,n.jsx)(h.v,{isStreaming:ev||ex,isTemporary:!!(null==r?void 0:r.is_temporary),chatInputDefaultMessage:A,conversationTitle:r?"".concat(r.name," - Claude"):"Claude",conversationUuid:C,isLoading:T||!N&&z||eb,messageUuids:Y,name:null!=(l=null!=(i=null==N?void 0:N.name)?i:null==r?void 0:r.name)?l:"Untitled Chat",onSend:ep,onRetry:e_,projectUuid:B,changeDisplayedConversationPath:eh,editMessage:ey,setPersonalizedStyleCallback:er,onToolAllow:$,retryCount:eo,onStopSampling:ex?ej:void 0}),(0,n.jsx)(O,{isModalOpen:H,currentTool:W,currentToolInput:X,currentServer:Z,handleDeny:J,handleAllow:$,handleAlwaysAllow:ee})]})}var Q=a(71302),B=a(16304);function K(e){var t;let{uuid:a,q:o}=e,{data:u,currentPath:d,isLoading:c}=(0,s.Bq)(a);return(0,i.K7)(null!=(t=null==u?void 0:u.name)?t:""),(0,B.V)(a,d||[],c),(0,n.jsxs)(n.Fragment,{children:[(0,n.jsx)(r.u,{conversationUuid:a,children:(0,n.jsx)(l._,{conversationUuid:a,children:(0,n.jsx)(q,{conversation:u,conversationUuid:a,chatInputDefaultMessage:o})})}),(0,n.jsx)(Q.PaymentVerificationModal,{})]})}}}]);